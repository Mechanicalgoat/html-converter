// 変換とダウンロード処理
        function convertAndDownload() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const fileInput = document.getElementById('html-file');
            const isSvgFile = fileInput.files.length > 0 && 
                             fileInput.files[0].name.toLowerCase().endsWith('.svg');
            
            // プレビューが空の場合
            if (htmlPreview.innerHTML.trim() === '') {
                statusMessage.textContent = 'エラー: プレビューが読み込まれていません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            // SVGファイルで直接表示の場合は特別処理
            if (isSvgFile) {
                const svgElement = htmlPreview.querySelector('svg');
                if (svgElement) {
                    handleSvgConversion(svgElement);
                    return;
                }
            }
            
            // HTMLファイルの場合
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            // ページ選択オプションをチェック
            const pageSelection = document.querySelector('input[name="page-selection"]:checked').value;
            const selectedPageNumber = parseInt(document.getElementById('page-number').value);
            
            // 複数ページの場合の処理
            if (pageSelection === 'all' && document.getElementById('page-options').style.display !== 'none') {
                // すべてのページを変換
                handleMultiplePages();
            } else {
                // 単一ページの処理
                const iframe = htmlPreview.querySelector('iframe');
                if (!iframe) {
                    statusMessage.textContent = 'エラー: プレビューフレームが見つかりません。';
                    statusMessage.className = 'error';
                    statusMessage.classList.remove('hidden');
                    return;
                }
                
                // 選択されたページに移動（複数ページの場合）
                if (pageSelection === 'selected') {
                    const frameDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const pages = getPages(frameDoc);
                    
                    if (pages.length > 0 && selectedPageNumber <= pages.length) {
                        // 他のページを非表示にする
                        pages.forEach((page, index) => {
                            page.style.display = (index + 1 === selectedPageNumber) ? 'block' : 'none';
                        });
                    }
                }
                
                // 少し遅延を入れて変換処理を開始
                setTimeout(() => {
                    convertSinglePage(iframe);
                }, 300);
            }
        }
        
        // 単一ページの変換処理
        function convertSinglePage(iframe) {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const targetDocument = iframe.contentDocument || iframe.contentWindow.document;
            const targetElement = targetDocument.documentElement;
            
            if (selectedFormat === 'svg') {
                // SVG形式で保存
                convertToSVG(targetElement);
            } else {
                // JPGまたはPDF形式で保存
                html2canvas(targetElement, {
                    scale: 2,  // 高品質化のためスケールを上げる
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: htmlPreview.offsetWidth,
                    height: htmlPreview.offsetHeight,
                    windowWidth: htmlPreview.offsetWidth,
                    windowHeight: htmlPreview.offsetHeight
                }).then(canvas => {
                    try {
                        if (selectedFormat === 'jpg') {
                            // JPGとしてダウンロード
                            const link = document.createElement('a');
                            link.download = getFileName('jpg');
                            link.href = canvas.toDataURL('image/jpeg', outputQuality);
                            link.click();
                            
                            statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                        } else {
                            // PDFとしてダウンロード
                            const width = htmlPreview.offsetWidth;
                            const height = htmlPreview.offsetHeight;
                            
                            // PDFのサイズとページ設定
                            const pdf = new jsPDF({
                                orientation: height > width ? 'portrait' : 'landscape',
                                unit: 'px',
                                format: [width, height],
                                compress: true,
                                hotfixes: ['px_scaling']
                            });
                            
                            // 画像をPDFに追加（高品質）
                            pdf.addImage(
                                canvas.toDataURL('image/jpeg', 1.0),
                                'JPEG',
                                0,
                                0,
                                width,
                                height,
                                undefined,
                                'FAST'
                            );
                            
                            pdf.save(getFileName('pdf'));
                            
                            statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                        }
                        
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    } catch (error) {
                        console.error('変換エラー:', error);
                        statusMessage.textContent = 'エラーが発生しました。もう一度お試しください。';
                        statusMessage.className = '';
                        statusMessage.classList.add('error');
                    }
                }).catch(error => {
                    console.error('HTML2Canvas エラー:', error);
                    statusMessage.textContent = '変換中にエラーが発生しました。HTMLの内容を確認してください。';
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                });
            }
        }
        
        // 複数ページの処理
        function handleMultiplePages() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const iframe = htmlPreview.querySelector('iframe');
            
            if (!iframe) {
                statusMessage.textContent = 'エラー: プレビューフレームが見つかりません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            const frameDoc = iframe.contentDocument || iframe.contentWindow.document;
            const pages = getPages(frameDoc);
            
            if (pages.length === 0) {
                // ページが見つからない場合は単一ページとして処理
                convertSinglePage(iframe);
                return;
            }
            
            // 複数ページの場合の処理（PDFのみ対応）
            if (selectedFormat === 'pdf') {
                createMultiPagePdf(iframe, pages);
            } else {
                // 複数のファイルを作成
                createMultipleFiles(iframe, pages);
            }
        }
        
        // ページ要素を取得
        function getPages(doc) {
            // 一般的なページ区切り要素を探す
            let pages = [];
            
            // class="page"を持つdiv要素
            pages = Array.from(doc.querySelectorAll('div.page'));
            if (pages.length > 0) return pages;
            
            // id="pageX"形式のdiv要素
            pages = Array.from(doc.querySelectorAll('div[id^="page"]'));
            if (pages.length > 0) return pages;
            
            // class="page"を持つsection要素
            pages = Array.from(doc.querySelectorAll('section.page'));
            if (pages.length > 0) return pages;
            
            // class="page"を持つarticle要素
            pages = Array.from(doc.querySelectorAll('article.page'));
            if (pages.length > 0) return pages;
            
            return [];
        }
        
        // 複数ページのPDF作成
        function createMultiPagePdf(iframe, pages) {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const width = htmlPreview.offsetWidth;
            const height = htmlPreview.offsetHeight;
            
            // PDFのインスタンスを作成
            const pdf = new jsPDF({
                orientation: height > width ? 'portrait' : 'landscape',
                unit: 'px',
                format: [width, height],
                compress: true,
                hotfixes: ['px_scaling']
            });
            
            let pageIndex = 0;
            statusMessage.textContent = `変換中... (ページ 1/${pages.length})`;
            
            // 各ページを処理する再帰関数
            function processPage() {
                // 他のページを非表示にする
                pages.forEach((page, i) => {
                    page.style.display = i === pageIndex ? 'block' : 'none';
                });
                
                // 現在のページをキャンバスに描画
                html2canvas(iframe.contentDocument.documentElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: width,
                    height: height,
                    windowWidth: width,
                    windowHeight: height
                }).then(canvas => {
                    // PDFに追加
                    if (pageIndex > 0) {
                        pdf.addPage();
                    }
                    
                    pdf.addImage(
                        canvas.toDataURL('image/jpeg', 1.0),
                        'JPEG',
                        0,
                        0,
                        width,
                        height,
                        undefined,
                        'FAST'
                    );
                    
                    pageIndex++;
                    statusMessage.textContent = `変換中... (ページ ${pageIndex + 1}/${pages.length})`;
                    
                    // 次のページ処理または保存
                    if (pageIndex < pages.length) {
                        setTimeout(processPage, 500);
                    } else {
                        pdf.save(getFileName('pdf'));
                        statusMessage.textContent = 'マルチページPDFのダウンロードが完了しました！';
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    }
                }).catch(error => {
                    console.error('Page conversion error:', error);
                    statusMessage.textContent = `ページ${pageIndex + 1}の変換中にエラーが発生しました。`;
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                });
            }
            
            // 最初のページから処理開始
            processPage();
        }
        
        // 複数のファイルの作成（JPG/SVG）
        function createMultipleFiles(iframe, pages) {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            
            let pageIndex = 0;
            let processedCount = 0;
            statusMessage.textContent = `変換中... (ページ 1/${pages.length})`;
            
            // 各ページを処理する再帰関数
            function processPage() {
                // 他のページを非表示にする
                pages.forEach((page, i) => {
                    page.style.display = i === pageIndex ? 'block' : 'none';
                });
                
                // 現在のページをキャンバスに描画
                html2canvas(iframe.contentDocument.documentElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: htmlPreview.offsetWidth,
                    height: htmlPreview.offsetHeight
                }).then(canvas => {
                    // ファイルをダウンロード
                    if (selectedFormat === 'jpg') {
                        const link = document.createElement('a');
                        link.download = getFileName('jpg', pageIndex + 1);
                        link.href = canvas.toDataURL('image/jpeg', outputQuality);
                        link.click();
                    } else if (selectedFormat === 'svg') {
                        // SVGは特殊処理が必要
                        try {
                            const serializer = new XMLSerializer();
                            let svgContent = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                            
                            // HTMLをSVGに変換
                            const pageElement = pages[pageIndex];
                            const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                            svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                            svgElement.setAttribute("viewBox", `0 0 ${htmlPreview.offsetWidth} ${htmlPreview.offsetHeight}`);
                            svgElement.setAttribute("width", htmlPreview.offsetWidth);
                            svgElement.setAttribute("height", htmlPreview.offsetHeight);
                            
                            // 外部オブジェクトとしてHTMLを埋め込み
                            const foreignObject = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                            foreignObject.setAttribute("width", "100%");
                            foreignObject.setAttribute("height", "100%");
                            
                            const clonedElement = pageElement.cloneNode(true);
                            foreignObject.appendChild(clonedElement);
                            svgElement.appendChild(foreignObject);
                            
                            svgContent += serializer.serializeToString(svgElement);
                            
                            // SVGファイルとして保存
                            const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                            saveAs(blob, getFileName('svg', pageIndex + 1));
                        } catch (error) {
                            console.error('SVG conversion error:', error);
                        }
                    }
                    
                    processedCount++;
                    pageIndex++;
                    
                    if (pageIndex < pages.length) {
                        statusMessage.textContent = `変換中... (ページ ${pageIndex + 1}/${pages.length})`;
                        setTimeout(processPage, 500);
                    } else {
                        statusMessage.textContent = `${pages.length}ページの変換が完了しました！`;
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    }
                }).catch(error => {
                    console.error('Page conversion error:', error);
                    processedCount++;
                    pageIndex++;
                    
                    if (pageIndex < pages.length) {
                        statusMessage.textContent = `ページ${pageIndex}のエラーをスキップして続行中... (${pageIndex + 1}/${pages.length})`;
                        setTimeout(processPage, 500);
                    } else {
                        statusMessage.textContent = `${processedCount}/${pages.length}ページの変換が完了しました。一部エラーがありました。`;
                        statusMessage.className = '';
                        statusMessage.classList.add('warning');
                    }
                });
            }
            
            // 最初のページから処理開始        // 複数ページがあるかチェック
        function checkMultiplePages(content) {
            // ページ区切りの正規表現パターン
            const pageSeparators = [
                /<div[^>]*class="?page"?[^>]*>/gi,
                /<div[^>]*id="?page[0-9]+"?[^>]*>/gi,
                /<section[^>]*class="?page"?[^>]*>/gi,
                /<article[^>]*class="?page"?[^>]*>/gi,
                /<hr[^>]*class="?page-break"?[^>]*>/gi,
                /<!-- *page-break *-->/gi,
                /<div[^>]*style="[^"]*page-break-before: always[^"]*"[^>]*>/gi,
                /<div[^>]*style="[^"]*page-break-after: always[^"]*"[^>]*>/gi
            ];
            
            // いずれかのパターンがマッチするかチェック
            let hasMultiplePages = false;
            let pageCount = 1;
            
            for (const pattern of pageSeparators) {
                const matches = content.match(pattern);
                if (matches && matches.length > 0) {
                    hasMultiplePages = true;
                    pageCount += matches.length;
                    break;
                }
            }
            
            // ページ数情報を更新
            document.getElementById('page-info').textContent = 
                hasMultiplePages ? `(${pageCount}ページ検出)` : '';
            document.getElementById('page-options').style.display = 
                hasMultiplePages ? 'block' : 'none';
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML変換ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .file-upload {
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
        }
        
        .file-upload input {
            position: absolute;
            top: 0;
            right: 0;
            margin: 0;
            padding: 0;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            filter: alpha(opacity=0);
        }
        
        select, button {
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .preview-container {
            margin: 20px auto;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            overflow: auto;
            max-width: 100%;
            background-color: #f9f9f9;
        }
        
        #html-preview {
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .step {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .format-options {
            display: flex;
            gap: 10px;
        }
        
        .format-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .format-option:hover {
            background-color: #f0f0f0;
        }
        
        .format-option.selected {
            background-color: #e7f4e7;
            border-color: #4CAF50;
            font-weight: bold;
        }
        
        #status-message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .hidden {
            display: none;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 5px;
        }
        
        #download-btn-container {
            display: flex;
            gap: 10px;
        }
        
        #download-btn-container button {
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            #download-btn-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HTML変換ツール</h1>
        <p style="text-align: center; margin-bottom: 20px;">HTMLファイルをJPG、PDF、SVG形式に変換できるシンプルなツールです。</p>
        
        <div class="section">
                            <div class="section-title">1. HTMLまたはSVGファイルをアップロード</div>
            <div class="step">
                <span class="step-number">1</span>
                <label for="html-file">HTMLまたはSVGファイルを選択:</label>
                <div class="file-upload">
                    ファイルを選択
                    <input type="file" id="html-file" accept=".html,.htm,.svg" onchange="handleFileUpload()">
                </div>
                <div id="file-name"></div>
                <div id="page-info" style="color: #666; margin-top: 5px; font-style: italic;"></div>
            </div>
            
            <div class="step" id="page-options" style="display: none;">
                <span class="step-number">2</span>
                <label>ページオプション:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="all-pages" name="page-selection" value="all" checked>
                        <label for="all-pages">すべてのページを変換</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="selected-page" name="page-selection" value="selected">
                        <label for="selected-page">指定したページのみ変換</label>
                    </div>
                </div>
                
                <div id="page-number-container" style="display: none; margin-top: 10px;">
                    <label for="page-number">ページ番号:</label>
                    <input type="number" id="page-number" min="1" value="1" style="width: 80px; padding: 8px; margin-left: 10px;">
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">2. 出力設定</div>
            <div class="step">
                <span class="step-number">2</span>
                <div class="input-group">
                    <label>サイズ形式:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="square" name="size-format" value="square" checked>
                            <label for="square">正方形 (1:1)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="vertical" name="size-format" value="vertical">
                            <label for="vertical">縦型スライド (9:16)</label>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="size-preset">プリセットサイズ:</label>
                    <select id="size-preset" onchange="updateCustomSize()">
                        <option value="small">小 (500px)</option>
                        <option value="medium" selected>中 (800px)</option>
                        <option value="large">大 (1200px)</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                
                <div id="custom-size-container" class="hidden">
                    <div class="input-group">
                        <label for="custom-width">幅 (px):</label>
                        <input type="number" id="custom-width" min="100" max="2000" value="800">
                    </div>
                    <div class="input-group">
                        <label for="custom-height">高さ (px):</label>
                        <input type="number" id="custom-height" min="100" max="2000" value="800">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">3. プレビュー</div>
            <div class="step">
                <span class="step-number">3</span>
                <div class="input-group">
                    <label for="quality-slider">画質:</label>
                    <input type="range" id="quality-slider" min="70" max="100" value="95" oninput="updateQualityValue()">
                    <span id="quality-value">95%</span>
                </div>
                
                <button id="preview-btn" disabled onclick="renderPreview()">プレビュー表示</button>
                <div class="preview-container">
                    <div id="html-preview"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">4. 変換して保存</div>
            <div class="step">
                <span class="step-number">4</span>
                <label>出力形式を選択:</label>
                <div class="format-options">
                    <div class="format-option selected" onclick="selectFormat('jpg')">JPG</div>
                    <div class="format-option" onclick="selectFormat('pdf')">PDF</div>
                    <div class="format-option" onclick="selectFormat('svg')">SVG</div>
                </div>
                
                <div id="download-btn-container">
                    <button id="convert-btn" disabled onclick="convertAndDownload()">変換してダウンロード</button>
                </div>
                
                <div id="status-message" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let htmlContent = '';
        let selectedFormat = 'jpg';
        let outputQuality = 0.95;
        const { jsPDF } = window.jspdf;
        
        // フォーマット選択
        function selectFormat(format) {
            selectedFormat = format;
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 選択されたフォーマットに応じて対応するオプションを選択状態にする
            const formatIndex = format === 'jpg' ? 1 : (format === 'pdf' ? 2 : 3);
            document.querySelector(`.format-option:nth-child(${formatIndex})`).classList.add('selected');
        }
        
        // フォーマット選択
        function selectFormat(format) {
            selectedFormat = format;
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 選択されたフォーマットに応じて対応するオプションを選択状態にする
            const formatIndex = format === 'jpg' ? 1 : (format === 'pdf' ? 2 : 3);
            document.querySelector(`.format-option:nth-child(${formatIndex})`).classList.add('selected');
            
            // JPGの場合のみ品質スライダーを表示
            const qualityContainer = document.getElementById('quality-container');
            qualityContainer.style.display = format === 'jpg' ? 'block' : 'none';
        }
        
        // ファイルアップロード処理
        function handleFileUpload() {
            const fileInput = document.getElementById('html-file');
            const fileNameDisplay = document.getElementById('file-name');
            const previewBtn = document.getElementById('preview-btn');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameDisplay.textContent = file.name;
                
                // ファイル拡張子を取得
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                // SVGファイルの場合
                if (fileExt === 'svg') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        htmlContent = e.target.result;
                        previewBtn.disabled = false;
                        // SVG形式を選択
                        selectFormat('svg');
                    };
                    reader.readAsText(file);
                } 
                // HTMLファイルの場合
                else if (fileExt === 'html' || fileExt === 'htm') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        htmlContent = e.target.result;
                        previewBtn.disabled = false;
                        
                        // 複数ページが含まれているか確認
                        checkMultiplePages(htmlContent);
                    };
                    reader.readAsText(file);
                }
                // その他のファイル形式
                else {
                    fileNameDisplay.textContent = 'サポートされていないファイル形式です';
                    previewBtn.disabled = true;
                }
            } else {
                fileNameDisplay.textContent = '';
                previewBtn.disabled = true;
            }
        }
        
        // サイズプリセット更新
        function updateCustomSize() {
            const sizePreset = document.getElementById('size-preset').value;
            const customSizeContainer = document.getElementById('custom-size-container');
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');
            const sizeFormat = document.querySelector('input[name="size-format"]:checked').value;
            
            customSizeContainer.classList.toggle('hidden', sizePreset !== 'custom');
            
            let width, height;
            
            switch(sizePreset) {
                case 'small':
                    width = 500;
                    break;
                case 'medium':
                    width = 800;
                    break;
                case 'large':
                    width = 1200;
                    break;
                case 'custom':
                    return; // カスタムの場合は何もしない
            }
            
            if (sizeFormat === 'square') {
                height = width;
            } else { // vertical
                height = Math.round(width * (16/9));
            }
            
            customWidth.value = width;
            customHeight.value = height;
            
            // プレビューが表示されている場合は更新
            renderPreview();
        }
        
        // プレビュー表示
        function renderPreview() {
            const htmlPreview = document.getElementById('html-preview');
            const convertBtn = document.getElementById('convert-btn');
            const sizeFormat = document.querySelector('input[name="size-format"]:checked').value;
            const sizePreset = document.getElementById('size-preset').value;
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');
            const fileInput = document.getElementById('html-file');
            
            let width, height;
            
            if (sizePreset === 'custom') {
                width = parseInt(customWidth.value);
                height = parseInt(customHeight.value);
            } else {
                switch(sizePreset) {
                    case 'small':
                        width = 500;
                        break;
                    case 'medium':
                        width = 800;
                        break;
                    case 'large':
                        width = 1200;
                        break;
                }
                
                if (sizeFormat === 'square') {
                    height = width;
                } else { // vertical
                    height = Math.round(width * (16/9));
                }
            }
            
            // プレビューコンテナを調整
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            const contentFrame = document.createElement('iframe');
            contentFrame.style.width = '100%';
            contentFrame.style.height = '100%';
            contentFrame.style.border = 'none';
            contentFrame.style.overflow = 'hidden';
            htmlPreview.appendChild(contentFrame);
            
            // iframeのコンテンツをロード
            const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(htmlContent);
            frameDoc.close();
            
            // スケーリングスタイルを追加
            const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
            const scaleStyle = document.createElement('style');
            scaleStyle.type = 'text/css';
            scaleStyle.textContent = `
                html, body {
                    margin: 0;
                    padding: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                body {
                    font-size: 16px;
                    line-height: 1.5;
                }
                
                * {
                    box-sizing: border-box;
                    max-width: 100%;
                    word-wrap: break-word;
                }
                
                img, video, canvas, svg {
                    max-width: 100%;
                    height: auto;
                }
                
                table {
                    table-layout: fixed;
                    width: 100%;
                }
                
                @media print {
                    body {
                        width: 100%;
                        height: 100%;
                    }
                }
            `;
            frameHead.appendChild(scaleStyle);
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // SVGファイルかどうかを確認
            const isSvgFile = fileInput.files.length > 0 && 
                             fileInput.files[0].name.toLowerCase().endsWith('.svg');
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            
            if (isSvgFile) {
                // SVGの場合は直接挿入
                htmlPreview.innerHTML = htmlContent;
                
                // スタイルを適用
                const svgElement = htmlPreview.querySelector('svg');
                if (svgElement) {
                    svgElement.style.width = '100%';
                    svgElement.style.height = '100%';
                    svgElement.style.display = 'block';
                }
            } else {
                // HTMLの場合はiframeを使用
                const contentFrame = document.createElement('iframe');
                contentFrame.style.width = '100%';
                contentFrame.style.height = '100%';
                contentFrame.style.border = 'none';
                contentFrame.style.overflow = 'hidden';
                htmlPreview.appendChild(contentFrame);
                
                // iframeのコンテンツをロード
                const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
                frameDoc.open();
                frameDoc.write(htmlContent);
                frameDoc.close();
                
                // スケーリングスタイルを追加
                const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
                const scaleStyle = document.createElement('style');
                scaleStyle.type = 'text/css';
                scaleStyle.textContent = `
                    html, body {
                        margin: 0;
                        padding: 0;
                        width: 100%;
                        height: 100%;
                        overflow: hidden;
                    }
                    
                    body {
                        font-size: 16px;
                        line-height: 1.5;
                    }
                    
                    * {
                        box-sizing: border-box;
                        max-width: 100%;
                        word-wrap: break-word;
                    }
                    
                    img, video, canvas, svg {
                        max-width: 100%;
                        height: auto;
                    }
                    
                    table {
                        table-layout: fixed;
                        width: 100%;
                    }
                    
                    @media print {
                        body {
                            width: 100%;
                            height: 100%;
                        }
                    }
                `;
                frameHead.appendChild(scaleStyle);
            }
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
        }
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            const contentFrame = document.createElement('iframe');
            contentFrame.style.width = '100%';
            contentFrame.style.height = '100%';
            contentFrame.style.border = 'none';
            contentFrame.style.overflow = 'hidden';
            htmlPreview.appendChild(contentFrame);
            
            // iframeのコンテンツをロード
            const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(htmlContent);
            frameDoc.close();
            
            // スケーリングスタイルを追加
            const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
            const scaleStyle = document.createElement('style');
            scaleStyle.type = 'text/css';
            scaleStyle.textContent = `
                html, body {
                    margin: 0;
                    padding: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                body {
                    font-size: 16px;
                    line-height: 1.5;
                }
                
                * {
                    box-sizing: border-box;
                    max-width: 100%;
                    word-wrap: break-word;
                }
                
                img, video, canvas, svg {
                    max-width: 100%;
                    height: auto;
                }
                
                table {
                    table-layout: fixed;
                    width: 100%;
                }
                
                @media print {
                    body {
                        width: 100%;
                        height: 100%;
                    }
                }
            `;
            frameHead.appendChild(scaleStyle);
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
        }
        
        // サイズフォーマット変更時のイベント
        document.querySelectorAll('input[name="size-format"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updateCustomSize();
            });
        });
        
        // 変換とダウンロード処理
        function convertAndDownload() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const iframe = htmlPreview.querySelector('iframe');
            const fileInput = document.getElementById('html-file');
            const isSvgFile = fileInput.files.length > 0 && 
                             fileInput.files[0].name.toLowerCase().endsWith('.svg');
            
            // SVGファイルで直接表示の場合は特別処理
            if (isSvgFile && !iframe) {
                const svgElement = htmlPreview.querySelector('svg');
                if (svgElement) {
                    handleSvgConversion(svgElement);
                    return;
                }
            }
            
            if (!iframe && !isSvgFile) {
                statusMessage.textContent = 'エラー: プレビューが読み込まれていません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            // 少し遅延を入れて変換処理を開始（UIの反応を良くするため）
            setTimeout(() => {
                // 高さを確実に取得
                const targetDocument = iframe.contentDocument || iframe.contentWindow.document;
                const targetElement = targetDocument.documentElement;
                
                if (selectedFormat === 'svg') {
                    // SVG形式で保存
                    convertToSVG(targetElement);
                } else {
                    // JPGまたはPDF形式で保存
                    html2canvas(targetElement, {
                        scale: 2,  // 高品質化のためスケールを上げる
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        width: htmlPreview.offsetWidth,
                        height: htmlPreview.offsetHeight,
                        windowWidth: htmlPreview.offsetWidth,
                        windowHeight: htmlPreview.offsetHeight
                    }).then(canvas => {
                        try {
                            if (selectedFormat === 'jpg') {
                                // JPGとしてダウンロード
                                const link = document.createElement('a');
                                link.download = getFileName('jpg');
                                link.href = canvas.toDataURL('image/jpeg', outputQuality); // 設定された品質を使用
                                link.click();
                                
                                statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                            } else {
                                // PDFとしてダウンロード
                                const width = htmlPreview.offsetWidth;
                                const height = htmlPreview.offsetHeight;
                                
                                // PDFのサイズとページ設定
                                const pdf = new jsPDF({
                                    orientation: height > width ? 'portrait' : 'landscape',
                                    unit: 'px',
                                    format: [width, height],
                                    compress: true,
                                    hotfixes: ['px_scaling']
                                });
                                
                                // 画像をPDFに追加（高品質）
                                pdf.addImage(
                                    canvas.toDataURL('image/jpeg', 1.0),
                                    'JPEG',
                                    0,
                                    0,
                                    width,
                                    height,
                                    undefined,
                                    'FAST'
                                );
                                
                                pdf.save(getFileName('pdf'));
                                
                                statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                            }
                            
                            statusMessage.className = '';
                            statusMessage.classList.add('success');
                        } catch (error) {
                            console.error('変換エラー:', error);
                            statusMessage.textContent = 'エラーが発生しました。もう一度お試しください。';
                            statusMessage.className = '';
                            statusMessage.classList.add('error');
                        }
                    }).catch(error => {
                        console.error('HTML2Canvas エラー:', error);
                        statusMessage.textContent = '変換中にエラーが発生しました。HTMLの内容を確認してください。';
                        statusMessage.className = '';
                        statusMessage.classList.add('error');
                    });
                }
            }, 300); // 少し長めの遅延
        }
        
        // SVGファイル変換の特別処理
        function handleSvgConversion(svgElement) {
            const statusMessage = document.getElementById('status-message');
            
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            try {
                // SVG要素からSVG文字列を取得
                const serializer = new XMLSerializer();
                let svgContent = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                svgContent += serializer.serializeToString(svgElement);
                
                if (selectedFormat === 'svg') {
                    // SVGとして保存
                    const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    saveAs(blob, getFileName('svg'));
                    
                    statusMessage.textContent = 'SVGファイルのダウンロードが完了しました！';
                } else {
                    // SVGからキャンバスを作成して他の形式に変換
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const htmlPreview = document.getElementById('html-preview');
                        canvas.width = htmlPreview.offsetWidth;
                        canvas.height = htmlPreview.offsetHeight;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        if (selectedFormat === 'jpg') {
                            // JPGとして保存
                            const link = document.createElement('a');
                            link.download = getFileName('jpg');
                            link.href = canvas.toDataURL('image/jpeg', outputQuality);
                            link.click();
                            
                            statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                        } else {
                            // PDFとして保存
                            const pdf = new jsPDF({
                                orientation: canvas.height > canvas.width ? 'portrait' : 'landscape',
                                unit: 'px',
                                format: [canvas.width, canvas.height],
                                compress: true
                            });
                            
                            pdf.addImage(
                                canvas.toDataURL('image/jpeg', 1.0),
                                'JPEG',
                                0,
                                0,
                                canvas.width,
                                canvas.height
                            );
                            
                            pdf.save(getFileName('pdf'));
                            
                            statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                        }
                    };
                    
                    const svgBlob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svgBlob);
                    img.src = url;
                }
                
                statusMessage.className = '';
                statusMessage.classList.add('success');
            } catch (error) {
                console.error('SVG変換エラー:', error);
                statusMessage.textContent = 'SVG変換中にエラーが発生しました。';
                statusMessage.className = '';
                statusMessage.classList.add('error');
            }
        }
        
        // SVG形式に変換する処理
        function convertToSVG(element) {
            const statusMessage = document.getElementById('status-message');
            const htmlPreview = document.getElementById('html-preview');
            
            // DOM to Image を使用してSVGを作成
            domtoimage.toSvg(element, {
                width: htmlPreview.offsetWidth,
                height: htmlPreview.offsetHeight,
                style: {
                    'transform': 'scale(1)',
                    'transform-origin': 'top left'
                }
            })
            .then(function(dataUrl) {
                // Base64エンコードされたSVGデータをデコード
                const svgContent = atob(dataUrl.split(',')[1]);
                
                // SVGファイルとして保存
                const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                saveAs(blob, getFileName('svg'));
                
                statusMessage.textContent = 'SVGファイルのダウンロードが完了しました！';
                statusMessage.className = '';
                statusMessage.classList.add('success');
            })
            .catch(function(error) {
                console.error('SVG変換エラー:', error);
                
                // 代替手段を試行
                try {
                    // HTMLの内容からSVGを直接作成
                    const serializer = new XMLSerializer();
                    let svgContent = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                    
                    // SVG要素を作成
                    const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                    svgElement.setAttribute("viewBox", `0 0 ${htmlPreview.offsetWidth} ${htmlPreview.offsetHeight}`);
                    svgElement.setAttribute("width", htmlPreview.offsetWidth);
                    svgElement.setAttribute("height", htmlPreview.offsetHeight);
                    
                    // HTMLの内容を外部オブジェクトとして配置
                    const foreignObject = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                    foreignObject.setAttribute("width", "100%");
                    foreignObject.setAttribute("height", "100%");
                    
                    // HTMLコンテンツのクローンを作成
                    const clonedElement = element.cloneNode(true);
                    foreignObject.appendChild(clonedElement);
                    svgElement.appendChild(foreignObject);
                    
                    // SVG文字列に変換
                    svgContent += serializer.serializeToString(svgElement);
                    
                    // SVGファイルとして保存
                    const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    saveAs(blob, getFileName('svg'));
                    
                    statusMessage.textContent = 'SVGファイルのダウンロードが完了しました！';
                    statusMessage.className = '';
                    statusMessage.classList.add('success');
                } catch (backupError) {
                    console.error('SVG代替変換エラー:', backupError);
                    statusMessage.textContent = 'SVG変換中にエラーが発生しました。他の形式を試してください。';
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                }
            });
        }
        
        // ファイル名生成
        function getFileName(extension) {
            const fileInput = document.getElementById('html-file');
            let baseName = 'converted-html';
            
            if (fileInput.files.length > 0) {
                const originalFileName = fileInput.files[0].name;
                baseName = originalFileName.replace(/\.[^/.]+$/, ""); // 拡張子を削除
            }
            
            const date = new Date();
            const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
            
            return `${baseName}_${timestamp}.${extension}`;
        }
        
        // 画質スライダーの値更新
        function updateQualityValue() {
            const slider = document.getElementById('quality-slider');
            const valueDisplay = document.getElementById('quality-value');
            
            valueDisplay.textContent = `${slider.value}%`;
            outputQuality = parseInt(slider.value) / 100;
        }
        
        // ページ選択ラジオボタンのイベント
        document.addEventListener('DOMContentLoaded', function() {
            // ページ選択ラジオボタンのイベント
            const pageSelectionRadios = document.querySelectorAll('input[name="page-selection"]');
            const pageNumberContainer = document.getElementById('page-number-container');
            
            pageSelectionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    pageNumberContainer.style.display = 
                        this.value === 'selected' ? 'block' : 'none';
                });
            });
            
            // 初期化
            updateCustomSize();
            updateQualityValue();
        });
    </script>
</body>
</html>
// 画質スライダーの値更新
        function updateQualityValue() {
            const slider = document.getElementById('quality-slider');
            const valueDisplay = document.getElementById('quality-value');
            
            valueDisplay.textContent = `${slider.value}%`;
            outputQuality = parseInt(slider.value) / 100;
        }        // 変換とダウンロード処理
        function convertAndDownload() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const fileInput = document.getElementById('html-file');
            const isSvgFile = fileInput.files.length > 0 && 
                             fileInput.files[0].name.toLowerCase().endsWith('.svg');
            
            // プレビューが空の場合
            if (htmlPreview.innerHTML.trim() === '') {
                statusMessage.textContent = 'エラー: プレビューが読み込まれていません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            // SVGファイルで直接表示の場合は特別処理
            if (isSvgFile) {
                const svgElement = htmlPreview.querySelector('svg');
                if (svgElement) {
                    handleSvgConversion(svgElement);
                    return;
                }
            }
            
            // HTMLファイルの場合
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            // ページ選択オプションをチェック
            const pageSelection = document.querySelector('input[name="page-selection"]:checked').value;
            const selectedPageNumber = parseInt(document.getElementById('page-number').value);
            
            // 複数ページの場合の処理
            if (pageSelection === 'all' && document.getElementById('page-options').style.display !== 'none') {
                // すべてのページを変換
                handleMultiplePages();
            } else {
                // 単一ページの処理
                const iframe = htmlPreview.querySelector('iframe');
                if (!iframe) {
                    statusMessage.textContent = 'エラー: プレビューフレームが見つかりません。';
                    statusMessage.className = 'error';
                    statusMessage.classList.remove('hidden');
                    return;
                }
                
                // 選択されたページに移動（複数ページの場合）
                if (pageSelection === 'selected') {
                    const frameDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const pages = getPages(frameDoc);
                    
                    if (pages.length > 0 && selectedPageNumber <= pages.length) {
                        // 他のページを非表示にする
                        pages.forEach((page, index) => {
                            page.style.display = (index + 1 === selectedPageNumber) ? 'block' : 'none';
                        });
                    }
                }
                
                // 少し遅延を入れて変換処理を開始
                setTimeout(() => {
                    convertSinglePage(iframe);
                }, 300);
            }
        }
        
        // 単一ページの変換処理
        function convertSinglePage(iframe) {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const targetDocument = iframe.contentDocument || iframe.contentWindow.document;
            const targetElement = targetDocument.documentElement;
            
            if (selectedFormat === 'svg') {
                // SVG形式で保存
                convertToSVG(targetElement);
            } else {
                // JPGまたはPDF形式で保存
                html2canvas(targetElement, {
                    scale: 2,  // 高品質化のためスケールを上げる
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: htmlPreview.offsetWidth,
                    height: htmlPreview.offsetHeight,
                    windowWidth: htmlPreview.offsetWidth,
                    windowHeight: htmlPreview.offsetHeight
                }).then(canvas => {
                    try {
                        if (selectedFormat === 'jpg') {
                            // JPGとしてダウンロード
                            const link = document.createElement('a');
                            link.download = getFileName('jpg');
                            link.href = canvas.toDataURL('image/jpeg', outputQuality);
                            link.click();
                            
                            statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                        } else {
                            // PDFとしてダウンロード
                            const width = htmlPreview.offsetWidth;
                            const height = htmlPreview.offsetHeight;
                            
                            // PDFのサイズとページ設定
                            const pdf = new jsPDF({
                                orientation: height > width ? 'portrait' : 'landscape',
                                unit: 'px',
                                format: [width, height],
                                compress: true,
                                hotfixes: ['px_scaling']
                            });
                            
                            // 画像をPDFに追加（高品質）
                            pdf.addImage(
                                canvas.toDataURL('image/jpeg', 1.0),
                                'JPEG',
                                0,
                                0,
                                width,
                                height,
                                undefined,
                                'FAST'
                            );
                            
                            pdf.save(getFileName('pdf'));
                            
                            statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                        }
                        
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    } catch (error) {
                        console.error('変換エラー:', error);
                        statusMessage.textContent = 'エラーが発生しました。もう一度お試しください。';
                        statusMessage.className = '';
                        statusMessage.classList.add('error');
                    }
                }).catch(error => {
                    console.error('HTML2Canvas エラー:', error);
                    statusMessage.textContent = '変換中にエラーが発生しました。HTMLの内容を確認してください。';
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                });
            }
        }
        
        // 複数ページの処理
        function handleMultiplePages() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const iframe = htmlPreview.querySelector('iframe');
            
            if (!iframe) {
                statusMessage.textContent = 'エラー: プレビューフレームが見つかりません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            const frameDoc = iframe.contentDocument || iframe.contentWindow.document;
            const pages = getPages(frameDoc);
            
            if (pages.length === 0) {
                // ページが見つからない場合は単一ページとして処理
                convertSinglePage(iframe);
                return;
            }
            
            // 複数ページの場合の処理（PDFのみ対応）
            if (selectedFormat === 'pdf') {
                createMultiPagePdf(iframe, pages);
            } else {
                // 複数のファイルを作成
                createMultipleFiles(iframe, pages);
            }
        }
        
        // ページ要素を取得
        function getPages(doc) {
            // 一般的なページ区切り要素を探す
            let pages = [];
            
            // class="page"を持つdiv要素
            pages = Array.from(doc.querySelectorAll('div.page'));
            if (pages.length > 0) return pages;
            
            // id="pageX"形式のdiv要素
            pages = Array.from(doc.querySelectorAll('div[id^="page"]'));
            if (pages.length > 0) return pages;
            
            // class="page"を持つsection要素
            pages = Array.from(doc.querySelectorAll('section.page'));
            if (pages.length > 0) return pages;
            
            // class="page"を持つarticle要素
            pages = Array.from(doc.querySelectorAll('article.page'));
            if (pages.length > 0) return pages;
            
            return [];
        }
        
        // 複数ページのPDF作成
        function createMultiPagePdf(iframe, pages) {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const width = htmlPreview.offsetWidth;
            const height = htmlPreview.offsetHeight;
            
            // PDFのインスタンスを作成
            const pdf = new jsPDF({
                orientation: height > width ? 'portrait' : 'landscape',
                unit: 'px',
                format: [width, height],
                compress: true,
                hotfixes: ['px_scaling']
            });
            
            let pageIndex = 0;
            statusMessage.textContent = `変換中... (ページ 1/${pages.length})`;
            
            // 各ページを処理する再帰関数
            function processPage() {
                // 他のページを非表示にする
                pages.forEach((page, i) => {
                    page.style.display = i === pageIndex ? 'block' : 'none';
                });
                
                // 現在のページをキャンバスに描画
                html2canvas(iframe.contentDocument.documentElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: width,
                    height: height,
                    windowWidth: width,
                    windowHeight: height
                }).then(canvas => {
                    // PDFに追加
                    if (pageIndex > 0) {
                        pdf.addPage();
                    }
                    
                    pdf.addImage(
                        canvas.toDataURL('image/jpeg', 1.0),
                        'JPEG',
                        0,
                        0,
                        width,
                        height,
                        undefined,
                        'FAST'
                    );
                    
                    pageIndex++;
                    statusMessage.textContent = `変換中... (ページ ${pageIndex + 1}/${pages.length})`;
                    
                    // 次のページ処理または保存
                    if (pageIndex < pages.length) {
                        setTimeout(processPage, 500);
                    } else {
                        pdf.save(getFileName('pdf'));
                        statusMessage.textContent = 'マルチページPDFのダウンロードが完了しました！';
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    }
                }).catch(error => {
                    console.error('Page conversion error:', error);
                    statusMessage.textContent = `ページ${pageIndex + 1}の変換中にエラーが発生しました。`;
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                });
            }
            
            // 最初のページから処理開始
            processPage();
        }
            processPage();
        }
        
        // 複数のファイルの作成（JPG/SVG）
        function createMultipleFiles(iframe, pages) {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            
            let pageIndex = 0;
            let processedCount = 0;
            statusMessage.textContent = `変換中... (ページ 1/${pages.length})`;
            
            // 各ページを処理する再帰関数
            function processPage() {
                // 他のページを非表示にする
                pages.forEach((page, i) => {
                    page.style.display = i === pageIndex ? 'block' : 'none';
                });
                
                // 現在のページをキャンバスに描画
                html2canvas(iframe.contentDocument.documentElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: htmlPreview.offsetWidth,
                    height: htmlPreview.offsetHeight
                }).then(canvas => {
                    // ファイルをダウンロード
                    if (selectedFormat === 'jpg') {
                        const link = document.createElement('a');
                        link.download = getFileName('jpg', pageIndex + 1);
                        link.href = canvas.toDataURL('image/jpeg', outputQuality);
                        link.click();
                    } else if (selectedFormat === 'svg') {
                        // SVGは特殊処理が必要
                        try {
                            const serializer = new XMLSerializer();
                            let svgContent = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                            
                            // HTMLをSVGに変換
                            const pageElement = pages[pageIndex];
                            const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                            svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                            svgElement.setAttribute("viewBox", `0 0 ${htmlPreview.offsetWidth} ${htmlPreview.offsetHeight}`);
                            svgElement.setAttribute("width", htmlPreview.offsetWidth);
                            svgElement.setAttribute("height", htmlPreview.offsetHeight);
                            
                            // 外部オブジェクトとしてHTMLを埋め込み
                            const foreignObject = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                            foreignObject.setAttribute("width", "100%");
                            foreignObject.setAttribute("height", "100%");
                            
                            const clonedElement = pageElement.cloneNode(true);
                            foreignObject.appendChild(clonedElement);
                            svgElement.appendChild(foreignObject);
                            
                            svgContent += serializer.serializeToString(svgElement);
                            
                            // SVGファイルとして保存
                            const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                            saveAs(blob, getFileName('svg', pageIndex + 1));
                        } catch (error) {
                            console.error('SVG conversion error:', error);
                        }
                    }
                    
                    processedCount++;
                    pageIndex++;
                    
                    if (pageIndex < pages.length) {
                        statusMessage.textContent = `変換中... (ページ ${pageIndex + 1}/${pages.length})`;
                        setTimeout(processPage, 500);
                    } else {
                        statusMessage.textContent = `${pages.length}ページの変換が完了しました！`;
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    }
                }).catch(error => {
                    console.error('Page conversion error:', error);
                    processedCount++;
                    pageIndex++;
                    
                    if (pageIndex < pages.length) {
                        statusMessage.textContent = `ページ${pageIndex}のエラーをスキップして続行中... (${pageIndex + 1}/${pages.length})`;
                        setTimeout(processPage, 500);
                    } else {
                        statusMessage.textContent = `${processedCount}/${pages.length}ページの変換が完了しました。一部エラーがありました。`;
                        statusMessage.className = '';
                        statusMessage.classList.add('warning');
                    }
                });
            }
            
            // 最初のページから処理開始        // 複数ページがあるかチェック
        function checkMultiplePages(content) {
            // ページ区切りの正規表現パターン
            const pageSeparators = [
                /<div[^>]*class="?page"?[^>]*>/gi,
                /<div[^>]*id="?page[0-9]+"?[^>]*>/gi,
                /<section[^>]*class="?page"?[^>]*>/gi,
                /<article[^>]*class="?page"?[^>]*>/gi,
                /<hr[^>]*class="?page-break"?[^>]*>/gi,
                /<!-- *page-break *-->/gi,
                /<div[^>]*style="[^"]*page-break-before: always[^"]*"[^>]*>/gi,
                /<div[^>]*style="[^"]*page-break-after: always[^"]*"[^>]*>/gi
            ];
            
            // いずれかのパターンがマッチするかチェック
            let hasMultiplePages = false;
            let pageCount = 1;
            
            for (const pattern of pageSeparators) {
                const matches = content.match(pattern);
                if (matches && matches.length > 0) {
                    hasMultiplePages = true;
                    pageCount += matches.length;
                    break;
                }
            }
            
            // ページ数情報を更新
            document.getElementById('page-info').textContent = 
                hasMultiplePages ? `(${pageCount}ページ検出)` : '';
            document.getElementById('page-options').style.display = 
                hasMultiplePages ? 'block' : 'none';
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML変換ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .file-upload {
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
        }
        
        .file-upload input {
            position: absolute;
            top: 0;
            right: 0;
            margin: 0;
            padding: 0;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            filter: alpha(opacity=0);
        }
        
        select, button {
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .preview-container {
            margin: 20px auto;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            overflow: auto;
            max-width: 100%;
            background-color: #f9f9f9;
        }
        
        #html-preview {
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .step {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .format-options {
            display: flex;
            gap: 10px;
        }
        
        .format-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .format-option:hover {
            background-color: #f0f0f0;
        }
        
        .format-option.selected {
            background-color: #e7f4e7;
            border-color: #4CAF50;
            font-weight: bold;
        }
        
        #status-message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .hidden {
            display: none;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 5px;
        }
        
        #download-btn-container {
            display: flex;
            gap: 10px;
        }
        
        #download-btn-container button {
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            #download-btn-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HTML変換ツール</h1>
        <p style="text-align: center; margin-bottom: 20px;">HTMLファイルをJPG、PDF、SVG形式に変換できるシンプルなツールです。</p>
        
        <div class="section">
                            <div class="section-title">1. HTMLまたはSVGファイルをアップロード</div>
            <div class="step">
                <span class="step-number">1</span>
                <label for="html-file">HTMLまたはSVGファイルを選択:</label>
                <div class="file-upload">
                    ファイルを選択
                    <input type="file" id="html-file" accept=".html,.htm,.svg" onchange="handleFileUpload()">
                </div>
                <div id="file-name"></div>
                <div id="page-info" style="color: #666; margin-top: 5px; font-style: italic;"></div>
            </div>
            
            <div class="step" id="page-options" style="display: none;">
                <span class="step-number">2</span>
                <label>ページオプション:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="all-pages" name="page-selection" value="all" checked>
                        <label for="all-pages">すべてのページを変換</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="selected-page" name="page-selection" value="selected">
                        <label for="selected-page">指定したページのみ変換</label>
                    </div>
                </div>
                
                <div id="page-number-container" style="display: none; margin-top: 10px;">
                    <label for="page-number">ページ番号:</label>
                    <input type="number" id="page-number" min="1" value="1" style="width: 80px; padding: 8px; margin-left: 10px;">
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">2. プレビューと変換</div>
            <div class="step">
                <span class="step-number">2</span>
                <div class="input-group">
                    <label>サイズ形式:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="square" name="size-format" value="square" checked>
                            <label for="square">正方形 (1:1)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="vertical" name="size-format" value="vertical">
                            <label for="vertical">縦型スライド (9:16)</label>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="size-preset">プリセットサイズ:</label>
                    <select id="size-preset" onchange="updateCustomSize()">
                        <option value="small">小 (500px)</option>
                        <option value="medium" selected>中 (800px)</option>
                        <option value="large">大 (1200px)</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                
                <div id="custom-size-container" class="hidden">
                    <div class="input-group">
                        <label for="custom-width">幅 (px):</label>
                        <input type="number" id="custom-width" min="100" max="2000" value="800">
                    </div>
                    <div class="input-group">
                        <label for="custom-height">高さ (px):</label>
                        <input type="number" id="custom-height" min="100" max="2000" value="800">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">3. プレビュー</div>
            <div class="step">
                <span class="step-number">3</span>
                <div class="input-group">
                    <label for="quality-slider">画質:</label>
                    <input type="range" id="quality-slider" min="70" max="100" value="95" oninput="updateQualityValue()">
                    <span id="quality-value">95%</span>
                </div>
                
                <button id="preview-btn" disabled onclick="renderPreview()">プレビュー表示</button>
                <div class="preview-container">
                    <div id="html-preview"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">3. 変換して保存</div>
            <div class="step">
                <span class="step-number">3</span>
                <label>出力形式を選択:</label>
                <div class="format-options">
                    <div class="format-option selected" onclick="selectFormat('jpg')">JPG</div>
                    <div class="format-option" onclick="selectFormat('pdf')">PDF</div>
                    <div class="format-option" onclick="selectFormat('svg')">SVG</div>
                </div>
                
                <div id="download-btn-container">
                    <button id="convert-btn" disabled onclick="convertAndDownload()">変換してダウンロード</button>
                </div>
                
                <div id="status-message" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let htmlContent = '';
        let selectedFormat = 'jpg';
        let outputQuality = 0.95;
        const { jsPDF } = window.jspdf;
        
        // フォーマット選択
        function selectFormat(format) {
            selectedFormat = format;
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 選択されたフォーマットに応じて対応するオプションを選択状態にする
            const formatIndex = format === 'jpg' ? 1 : (format === 'pdf' ? 2 : 3);
            document.querySelector(`.format-option:nth-child(${formatIndex})`).classList.add('selected');
        }
        
        // フォーマット選択
        function selectFormat(format) {
            selectedFormat = format;
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 選択されたフォーマットに応じて対応するオプションを選択状態にする
            const formatIndex = format === 'jpg' ? 1 : (format === 'pdf' ? 2 : 3);
            document.querySelector(`.format-option:nth-child(${formatIndex})`).classList.add('selected');
            
            // JPGの場合のみ品質スライダーを表示
            const qualityContainer = document.getElementById('quality-container');
            qualityContainer.style.display = format === 'jpg' ? 'block' : 'none';
        }
        
        // ファイルアップロード処理
        function handleFileUpload() {
            const fileInput = document.getElementById('html-file');
            const fileNameDisplay = document.getElementById('file-name');
            const previewBtn = document.getElementById('preview-btn');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameDisplay.textContent = file.name;
                
                // ファイル拡張子を取得
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                // SVGファイルの場合
                if (fileExt === 'svg') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        htmlContent = e.target.result;
                        previewBtn.disabled = false;
                        // SVG形式を選択
                        selectFormat('svg');
                    };
                    reader.readAsText(file);
                } 
                // HTMLファイルの場合
                else if (fileExt === 'html' || fileExt === 'htm') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        htmlContent = e.target.result;
                        previewBtn.disabled = false;
                        
                        // 複数ページが含まれているか確認
                        checkMultiplePages(htmlContent);
                    };
                    reader.readAsText(file);
                }
                // その他のファイル形式
                else {
                    fileNameDisplay.textContent = 'サポートされていないファイル形式です';
                    previewBtn.disabled = true;
                }
            } else {
                fileNameDisplay.textContent = '';
                previewBtn.disabled = true;
            }
        }
        
        // サイズプリセット更新
        function updateCustomSize() {
            const sizePreset = document.getElementById('size-preset').value;
            const customSizeContainer = document.getElementById('custom-size-container');
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');
            const sizeFormat = document.querySelector('input[name="size-format"]:checked').value;
            
            customSizeContainer.classList.toggle('hidden', sizePreset !== 'custom');
            
            let width, height;
            
            switch(sizePreset) {
                case 'small':
                    width = 500;
                    break;
                case 'medium':
                    width = 800;
                    break;
                case 'large':
                    width = 1200;
                    break;
                case 'custom':
                    return; // カスタムの場合は何もしない
            }
            
            if (sizeFormat === 'square') {
                height = width;
            } else { // vertical
                height = Math.round(width * (16/9));
            }
            
            customWidth.value = width;
            customHeight.value = height;
            
            // プレビューが表示されている場合は更新
            renderPreview();
        }
        
        // プレビュー表示
        function renderPreview() {
            const htmlPreview = document.getElementById('html-preview');
            const convertBtn = document.getElementById('convert-btn');
            const sizeFormat = document.querySelector('input[name="size-format"]:checked').value;
            const sizePreset = document.getElementById('size-preset').value;
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');
            const fileInput = document.getElementById('html-file');
            
            let width, height;
            
            if (sizePreset === 'custom') {
                width = parseInt(customWidth.value);
                height = parseInt(customHeight.value);
            } else {
                switch(sizePreset) {
                    case 'small':
                        width = 500;
                        break;
                    case 'medium':
                        width = 800;
                        break;
                    case 'large':
                        width = 1200;
                        break;
                }
                
                if (sizeFormat === 'square') {
                    height = width;
                } else { // vertical
                    height = Math.round(width * (16/9));
                }
            }
            
            // プレビューコンテナを調整
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            const contentFrame = document.createElement('iframe');
            contentFrame.style.width = '100%';
            contentFrame.style.height = '100%';
            contentFrame.style.border = 'none';
            contentFrame.style.overflow = 'hidden';
            htmlPreview.appendChild(contentFrame);
            
            // iframeのコンテンツをロード
            const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(htmlContent);
            frameDoc.close();
            
            // スケーリングスタイルを追加
            const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
            const scaleStyle = document.createElement('style');
            scaleStyle.type = 'text/css';
            scaleStyle.textContent = `
                html, body {
                    margin: 0;
                    padding: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                body {
                    font-size: 16px;
                    line-height: 1.5;
                }
                
                * {
                    box-sizing: border-box;
                    max-width: 100%;
                    word-wrap: break-word;
                }
                
                img, video, canvas, svg {
                    max-width: 100%;
                    height: auto;
                }
                
                table {
                    table-layout: fixed;
                    width: 100%;
                }
                
                @media print {
                    body {
                        width: 100%;
                        height: 100%;
                    }
                }
            `;
            frameHead.appendChild(scaleStyle);
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // SVGファイルかどうかを確認
            const isSvgFile = fileInput.files.length > 0 && 
                             fileInput.files[0].name.toLowerCase().endsWith('.svg');
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            
            if (isSvgFile) {
                // SVGの場合は直接挿入
                htmlPreview.innerHTML = htmlContent;
                
                // スタイルを適用
                const svgElement = htmlPreview.querySelector('svg');
                if (svgElement) {
                    svgElement.style.width = '100%';
                    svgElement.style.height = '100%';
                    svgElement.style.display = 'block';
                }
            } else {
                // HTMLの場合はiframeを使用
                const contentFrame = document.createElement('iframe');
                contentFrame.style.width = '100%';
                contentFrame.style.height = '100%';
                contentFrame.style.border = 'none';
                contentFrame.style.overflow = 'hidden';
                htmlPreview.appendChild(contentFrame);
                
                // iframeのコンテンツをロード
                const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
                frameDoc.open();
                frameDoc.write(htmlContent);
                frameDoc.close();
                
                // スケーリングスタイルを追加
                const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
                const scaleStyle = document.createElement('style');
                scaleStyle.type = 'text/css';
                scaleStyle.textContent = `
                    html, body {
                        margin: 0;
                        padding: 0;
                        width: 100%;
                        height: 100%;
                        overflow: hidden;
                    }
                    
                    body {
                        font-size: 16px;
                        line-height: 1.5;
                    }
                    
                    * {
                        box-sizing: border-box;
                        max-width: 100%;
                        word-wrap: break-word;
                    }
                    
                    img, video, canvas, svg {
                        max-width: 100%;
                        height: auto;
                    }
                    
                    table {
                        table-layout: fixed;
                        width: 100%;
                    }
                    
                    @media print {
                        body {
                            width: 100%;
                            height: 100%;
                        }
                    }
                `;
                frameHead.appendChild(scaleStyle);
            }
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
        }
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            const contentFrame = document.createElement('iframe');
            contentFrame.style.width = '100%';
            contentFrame.style.height = '100%';
            contentFrame.style.border = 'none';
            contentFrame.style.overflow = 'hidden';
            htmlPreview.appendChild(contentFrame);
            
            // iframeのコンテンツをロード
            const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(htmlContent);
            frameDoc.close();
            
            // スケーリングスタイルを追加
            const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
            const scaleStyle = document.createElement('style');
            scaleStyle.type = 'text/css';
            scaleStyle.textContent = `
                html, body {
                    margin: 0;
                    padding: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                body {
                    font-size: 16px;
                    line-height: 1.5;
                }
                
                * {
                    box-sizing: border-box;
                    max-width: 100%;
                    word-wrap: break-word;
                }
                
                img, video, canvas, svg {
                    max-width: 100%;
                    height: auto;
                }
                
                table {
                    table-layout: fixed;
                    width: 100%;
                }
                
                @media print {
                    body {
                        width: 100%;
                        height: 100%;
                    }
                }
            `;
            frameHead.appendChild(scaleStyle);
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
        }
        
        // サイズフォーマット変更時のイベント
        document.querySelectorAll('input[name="size-format"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updateCustomSize();
            });
        });
        
        // 変換とダウンロード処理
        function convertAndDownload() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const iframe = htmlPreview.querySelector('iframe');
            const fileInput = document.getElementById('html-file');
            const isSvgFile = fileInput.files.length > 0 && 
                             fileInput.files[0].name.toLowerCase().endsWith('.svg');
            
            // SVGファイルで直接表示の場合は特別処理
            if (isSvgFile && !iframe) {
                const svgElement = htmlPreview.querySelector('svg');
                if (svgElement) {
                    handleSvgConversion(svgElement);
                    return;
                }
            }
            
            if (!iframe && !isSvgFile) {
                statusMessage.textContent = 'エラー: プレビューが読み込まれていません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            // 少し遅延を入れて変換処理を開始（UIの反応を良くするため）
            setTimeout(() => {
                // 高さを確実に取得
                const targetDocument = iframe.contentDocument || iframe.contentWindow.document;
                const targetElement = targetDocument.documentElement;
                
                if (selectedFormat === 'svg') {
                    // SVG形式で保存
                    convertToSVG(targetElement);
                } else {
                    // JPGまたはPDF形式で保存
                    html2canvas(targetElement, {
                        scale: 2,  // 高品質化のためスケールを上げる
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        width: htmlPreview.offsetWidth,
                        height: htmlPreview.offsetHeight,
                        windowWidth: htmlPreview.offsetWidth,
                        windowHeight: htmlPreview.offsetHeight
                    }).then(canvas => {
                        try {
                            if (selectedFormat === 'jpg') {
                                // JPGとしてダウンロード
                                const link = document.createElement('a');
                                link.download = getFileName('jpg');
                                link.href = canvas.toDataURL('image/jpeg', outputQuality); // 設定された品質を使用
                                link.click();
                                
                                statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                            } else {
                                // PDFとしてダウンロード
                                const width = htmlPreview.offsetWidth;
                                const height = htmlPreview.offsetHeight;
                                
                                // PDFのサイズとページ設定
                                const pdf = new jsPDF({
                                    orientation: height > width ? 'portrait' : 'landscape',
                                    unit: 'px',
                                    format: [width, height],
                                    compress: true,
                                    hotfixes: ['px_scaling']
                                });
                                
                                // 画像をPDFに追加（高品質）
                                pdf.addImage(
                                    canvas.toDataURL('image/jpeg', 1.0),
                                    'JPEG',
                                    0,
                                    0,
                                    width,
                                    height,
                                    undefined,
                                    'FAST'
                                );
                                
                                pdf.save(getFileName('pdf'));
                                
                                statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                            }
                            
                            statusMessage.className = '';
                            statusMessage.classList.add('success');
                        } catch (error) {
                            console.error('変換エラー:', error);
                            statusMessage.textContent = 'エラーが発生しました。もう一度お試しください。';
                            statusMessage.className = '';
                            statusMessage.classList.add('error');
                        }
                    }).catch(error => {
                        console.error('HTML2Canvas エラー:', error);
                        statusMessage.textContent = '変換中にエラーが発生しました。HTMLの内容を確認してください。';
                        statusMessage.className = '';
                        statusMessage.classList.add('error');
                    });
                }
            }, 300); // 少し長めの遅延
        }
        
        // SVGファイル変換の特別処理
        function handleSvgConversion(svgElement) {
            const statusMessage = document.getElementById('status-message');
            
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            try {
                // SVG要素からSVG文字列を取得
                const serializer = new XMLSerializer();
                let svgContent = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                svgContent += serializer.serializeToString(svgElement);
                
                if (selectedFormat === 'svg') {
                    // SVGとして保存
                    const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    saveAs(blob, getFileName('svg'));
                    
                    statusMessage.textContent = 'SVGファイルのダウンロードが完了しました！';
                } else {
                    // SVGからキャンバスを作成して他の形式に変換
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const htmlPreview = document.getElementById('html-preview');
                        canvas.width = htmlPreview.offsetWidth;
                        canvas.height = htmlPreview.offsetHeight;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        if (selectedFormat === 'jpg') {
                            // JPGとして保存
                            const link = document.createElement('a');
                            link.download = getFileName('jpg');
                            link.href = canvas.toDataURL('image/jpeg', outputQuality);
                            link.click();
                            
                            statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                        } else {
                            // PDFとして保存
                            const pdf = new jsPDF({
                                orientation: canvas.height > canvas.width ? 'portrait' : 'landscape',
                                unit: 'px',
                                format: [canvas.width, canvas.height],
                                compress: true
                            });
                            
                            pdf.addImage(
                                canvas.toDataURL('image/jpeg', 1.0),
                                'JPEG',
                                0,
                                0,
                                canvas.width,
                                canvas.height
                            );
                            
                            pdf.save(getFileName('pdf'));
                            
                            statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                        }
                    };
                    
                    const svgBlob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svgBlob);
                    img.src = url;
                }
                
                statusMessage.className = '';
                statusMessage.classList.add('success');
            } catch (error) {
                console.error('SVG変換エラー:', error);
                statusMessage.textContent = 'SVG変換中にエラーが発生しました。';
                statusMessage.className = '';
                statusMessage.classList.add('error');
            }
        }
        
        // SVG形式に変換する処理
        function convertToSVG(element) {
            const statusMessage = document.getElementById('status-message');
            const htmlPreview = document.getElementById('html-preview');
            
            // DOM to Image を使用してSVGを作成
            domtoimage.toSvg(element, {
                width: htmlPreview.offsetWidth,
                height: htmlPreview.offsetHeight,
                style: {
                    'transform': 'scale(1)',
                    'transform-origin': 'top left'
                }
            })
            .then(function(dataUrl) {
                // Base64エンコードされたSVGデータをデコード
                const svgContent = atob(dataUrl.split(',')[1]);
                
                // SVGファイルとして保存
                const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                saveAs(blob, getFileName('svg'));
                
                statusMessage.textContent = 'SVGファイルのダウンロードが完了しました！';
                statusMessage.className = '';
                statusMessage.classList.add('success');
            })
            .catch(function(error) {
                console.error('SVG変換エラー:', error);
                
                // 代替手段を試行
                try {
                    // HTMLの内容からSVGを直接作成
                    const serializer = new XMLSerializer();
                    let svgContent = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                    
                    // SVG要素を作成
                    const svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                    svgElement.setAttribute("viewBox", `0 0 ${htmlPreview.offsetWidth} ${htmlPreview.offsetHeight}`);
                    svgElement.setAttribute("width", htmlPreview.offsetWidth);
                    svgElement.setAttribute("height", htmlPreview.offsetHeight);
                    
                    // HTMLの内容を外部オブジェクトとして配置
                    const foreignObject = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                    foreignObject.setAttribute("width", "100%");
                    foreignObject.setAttribute("height", "100%");
                    
                    // HTMLコンテンツのクローンを作成
                    const clonedElement = element.cloneNode(true);
                    foreignObject.appendChild(clonedElement);
                    svgElement.appendChild(foreignObject);
                    
                    // SVG文字列に変換
                    svgContent += serializer.serializeToString(svgElement);
                    
                    // SVGファイルとして保存
                    const blob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
                    saveAs(blob, getFileName('svg'));
                    
                    statusMessage.textContent = 'SVGファイルのダウンロードが完了しました！';
                    statusMessage.className = '';
                    statusMessage.classList.add('success');
                } catch (backupError) {
                    console.error('SVG代替変換エラー:', backupError);
                    statusMessage.textContent = 'SVG変換中にエラーが発生しました。他の形式を試してください。';
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                }
            });
        }
        
        // ファイル名生成
        function getFileName(extension, pageNumber = null) {
            const fileInput = document.getElementById('html-file');
            let baseName = 'converted-html';
            
            if (fileInput.files.length > 0) {
                const originalFileName = fileInput.files[0].name;
                baseName = originalFileName.replace(/\.[^/.]+$/, ""); // 拡張子を削除
            }
            
            const date = new Date();
            const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
            
            if (pageNumber !== null) {
                return `${baseName}_page${pageNumber}_${timestamp}.${extension}`;
            } else {
                return `${baseName}_${timestamp}.${extension}`;
            }
        }
        
        // 画質スライダーの値更新
        function updateQualityValue() {
            const slider = document.getElementById('quality-slider');
            const valueDisplay = document.getElementById('quality-value');
            
            valueDisplay.textContent = `${slider.value}%`;
            outputQuality = parseInt(slider.value) / 100;
        }
        
        // ページ選択ラジオボタンのイベント
        document.addEventListener('DOMContentLoaded', function() {
            // ページ選択ラジオボタンのイベント
            const pageSelectionRadios = document.querySelectorAll('input[name="page-selection"]');
            const pageNumberContainer = document.getElementById('page-number-container');
            
            pageSelectionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    pageNumberContainer.style.display = 
                        this.value === 'selected' ? 'block' : 'none';
                });
            });
            
            // 初期化
            updateCustomSize();
            updateQualityValue();
        });
    </script>
</body>
</html>
