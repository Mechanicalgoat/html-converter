<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML変換ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .file-upload {
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
        }
        
        .file-upload input {
            position: absolute;
            top: 0;
            right: 0;
            margin: 0;
            padding: 0;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            filter: alpha(opacity=0);
        }
        
        select, button {
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .preview-container {
            margin: 20px auto;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            overflow: auto;
            max-width: 100%;
            background-color: #f9f9f9;
        }
        
        #html-preview {
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .step {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .format-options {
            display: flex;
            gap: 10px;
        }
        
        .format-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .format-option.selected {
            background-color: #e7f4e7;
            border-color: #4CAF50;
        }
        
        #status-message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .hidden {
            display: none;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 5px;
        }
        
        #download-btn-container {
            display: flex;
            gap: 10px;
        }
        
        #download-btn-container button {
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            #download-btn-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HTML変換ツール</h1>
        <p style="text-align: center; margin-bottom: 20px;">HTMLファイルをJPGまたはPDFに変換できるシンプルなツールです。</p>
        
        <div class="section">
            <div class="section-title">1. HTMLファイルをアップロード</div>
            <div class="step">
                <span class="step-number">1</span>
                <label for="html-file">HTMLファイルを選択:</label>
                <div class="file-upload">
                    ファイルを選択
                    <input type="file" id="html-file" accept=".html,.htm" onchange="handleFileUpload()">
                </div>
                <div id="file-name"></div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">2. 出力サイズを選択</div>
            <div class="step">
                <span class="step-number">2</span>
                <div class="input-group">
                    <label>サイズ形式:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="square" name="size-format" value="square" checked>
                            <label for="square">正方形 (1:1)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="vertical" name="size-format" value="vertical">
                            <label for="vertical">縦型スライド (9:16)</label>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="size-preset">プリセットサイズ:</label>
                    <select id="size-preset" onchange="updateCustomSize()">
                        <option value="small">小 (500px)</option>
                        <option value="medium" selected>中 (800px)</option>
                        <option value="large">大 (1200px)</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                
                <div id="custom-size-container" class="hidden">
                    <div class="input-group">
                        <label for="custom-width">幅 (px):</label>
                        <input type="number" id="custom-width" min="100" max="2000" value="800">
                    </div>
                    <div class="input-group">
                        <label for="custom-height">高さ (px):</label>
                        <input type="number" id="custom-height" min="100" max="2000" value="800">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">3. プレビュー</div>
            <div class="step">
                <span class="step-number">3</span>
                <button id="preview-btn" disabled onclick="renderPreview()">プレビュー表示</button>
                <div class="preview-container">
                    <div id="html-preview"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">4. 変換して保存</div>
            <div class="step">
                <span class="step-number">4</span>
                <label>出力形式を選択:</label>
                <div class="format-options">
                    <div class="format-option selected" onclick="selectFormat('jpg')">JPG</div>
                    <div class="format-option" onclick="selectFormat('pdf')">PDF</div>
                </div>
                
                <div class="input-group">
                    <label for="quality-slider">画質:</label>
                    <input type="range" id="quality-slider" min="70" max="100" value="95" oninput="updateQualityValue()">
                    <span id="quality-value">95%</span>
                </div>
                
                <div id="download-btn-container">
                    <button id="convert-btn" disabled onclick="convertAndDownload()">変換してダウンロード</button>
                </div>
                
                <div id="status-message" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let htmlContent = '';
        let selectedFormat = 'jpg';
        let outputQuality = 0.95;
        const { jsPDF } = window.jspdf;
        
        // フォーマット選択
        function selectFormat(format) {
            selectedFormat = format;
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.format-option:nth-child(${format === 'jpg' ? '1' : '2'})`).classList.add('selected');
        }
        
        // ファイルアップロード処理
        function handleFileUpload() {
            const fileInput = document.getElementById('html-file');
            const fileNameDisplay = document.getElementById('file-name');
            const previewBtn = document.getElementById('preview-btn');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameDisplay.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    htmlContent = e.target.result;
                    previewBtn.disabled = false;
                };
                reader.readAsText(file);
            } else {
                fileNameDisplay.textContent = '';
                previewBtn.disabled = true;
            }
        }
        
        // サイズプリセット更新
        function updateCustomSize() {
            const sizePreset = document.getElementById('size-preset').value;
            const customSizeContainer = document.getElementById('custom-size-container');
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');
            const sizeFormat = document.querySelector('input[name="size-format"]:checked').value;
            
            customSizeContainer.classList.toggle('hidden', sizePreset !== 'custom');
            
            let width, height;
            
            switch(sizePreset) {
                case 'small':
                    width = 500;
                    break;
                case 'medium':
                    width = 800;
                    break;
                case 'large':
                    width = 1200;
                    break;
                case 'custom':
                    return; // カスタムの場合は何もしない
            }
            
            if (sizeFormat === 'square') {
                height = width;
            } else { // vertical
                height = Math.round(width * (16/9));
            }
            
            customWidth.value = width;
            customHeight.value = height;
            
            // プレビューが表示されている場合は更新
            renderPreview();
        }
        
        // プレビュー表示
        function renderPreview() {
            const htmlPreview = document.getElementById('html-preview');
            const convertBtn = document.getElementById('convert-btn');
            const sizeFormat = document.querySelector('input[name="size-format"]:checked').value;
            const sizePreset = document.getElementById('size-preset').value;
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');
            
            let width, height;
            
            if (sizePreset === 'custom') {
                width = parseInt(customWidth.value);
                height = parseInt(customHeight.value);
            } else {
                switch(sizePreset) {
                    case 'small':
                        width = 500;
                        break;
                    case 'medium':
                        width = 800;
                        break;
                    case 'large':
                        width = 1200;
                        break;
                }
                
                if (sizeFormat === 'square') {
                    height = width;
                } else { // vertical
                    height = Math.round(width * (16/9));
                }
            }
            
            // プレビューコンテナを調整
            const previewContainer = document.querySelector('.preview-container');
            previewContainer.style.maxWidth = `${width + 40}px`; // コンテナの最大幅を設定（余白含む）
            previewContainer.style.margin = '20px auto'; // 中央寄せ
            
            htmlPreview.style.width = `${width}px`;
            htmlPreview.style.height = `${height}px`;
            
            // HTMLコンテンツを挿入
            htmlPreview.innerHTML = '';
            const contentFrame = document.createElement('iframe');
            contentFrame.style.width = '100%';
            contentFrame.style.height = '100%';
            contentFrame.style.border = 'none';
            contentFrame.style.overflow = 'hidden';
            htmlPreview.appendChild(contentFrame);
            
            // iframeのコンテンツをロード
            const frameDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(htmlContent);
            frameDoc.close();
            
            // スケーリングスタイルを追加
            const frameHead = frameDoc.head || frameDoc.getElementsByTagName('head')[0];
            const scaleStyle = document.createElement('style');
            scaleStyle.type = 'text/css';
            scaleStyle.textContent = `
                html, body {
                    margin: 0;
                    padding: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                body {
                    font-size: 16px;
                    line-height: 1.5;
                }
                
                * {
                    box-sizing: border-box;
                    max-width: 100%;
                    word-wrap: break-word;
                }
                
                img, video, canvas, svg {
                    max-width: 100%;
                    height: auto;
                }
                
                table {
                    table-layout: fixed;
                    width: 100%;
                }
                
                @media print {
                    body {
                        width: 100%;
                        height: 100%;
                    }
                }
            `;
            frameHead.appendChild(scaleStyle);
            
            // 変換ボタンを有効化
            convertBtn.disabled = false;
        }
        
        // サイズフォーマット変更時のイベント
        document.querySelectorAll('input[name="size-format"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updateCustomSize();
            });
        });
        
        // 変換とダウンロード処理
        function convertAndDownload() {
            const htmlPreview = document.getElementById('html-preview');
            const statusMessage = document.getElementById('status-message');
            const iframe = htmlPreview.querySelector('iframe');
            
            if (!iframe) {
                statusMessage.textContent = 'エラー: プレビューが読み込まれていません。';
                statusMessage.className = 'error';
                statusMessage.classList.remove('hidden');
                return;
            }
            
            statusMessage.textContent = '変換中...';
            statusMessage.className = '';
            statusMessage.classList.add('success');
            statusMessage.classList.remove('hidden');
            
            // 少し遅延を入れて変換処理を開始（UIの反応を良くするため）
            setTimeout(() => {
                // 高さを確実に取得
                const targetDocument = iframe.contentDocument || iframe.contentWindow.document;
                const targetElement = targetDocument.documentElement;
                
                html2canvas(targetElement, {
                    scale: 2,  // 高品質化のためスケールを上げる
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: htmlPreview.offsetWidth,
                    height: htmlPreview.offsetHeight,
                    windowWidth: htmlPreview.offsetWidth,
                    windowHeight: htmlPreview.offsetHeight
                }).then(canvas => {
                    try {
                        if (selectedFormat === 'jpg') {
                            // JPGとしてダウンロード
                            const link = document.createElement('a');
                            link.download = getFileName('jpg');
                            link.href = canvas.toDataURL('image/jpeg', outputQuality); // 設定された品質を使用
                            link.click();
                            
                            statusMessage.textContent = 'JPGファイルのダウンロードが完了しました！';
                        } else {
                            // PDFとしてダウンロード
                            const width = htmlPreview.offsetWidth;
                            const height = htmlPreview.offsetHeight;
                            
                            // PDFのサイズとページ設定
                            const pdf = new jsPDF({
                                orientation: height > width ? 'portrait' : 'landscape',
                                unit: 'px',
                                format: [width, height],
                                compress: true,
                                hotfixes: ['px_scaling']
                            });
                            
                            // 画像をPDFに追加（高品質）
                            pdf.addImage(
                                canvas.toDataURL('image/jpeg', 1.0),
                                'JPEG',
                                0,
                                0,
                                width,
                                height,
                                undefined,
                                'FAST'
                            );
                            
                            pdf.save(getFileName('pdf'));
                            
                            statusMessage.textContent = 'PDFファイルのダウンロードが完了しました！';
                        }
                        
                        statusMessage.className = '';
                        statusMessage.classList.add('success');
                    } catch (error) {
                        console.error('変換エラー:', error);
                        statusMessage.textContent = 'エラーが発生しました。もう一度お試しください。';
                        statusMessage.className = '';
                        statusMessage.classList.add('error');
                    }
                }).catch(error => {
                    console.error('HTML2Canvas エラー:', error);
                    statusMessage.textContent = '変換中にエラーが発生しました。HTMLの内容を確認してください。';
                    statusMessage.className = '';
                    statusMessage.classList.add('error');
                });
            }, 300); // 少し長めの遅延
        }
        
        // ファイル名生成
        function getFileName(extension) {
            const fileInput = document.getElementById('html-file');
            let baseName = 'converted-html';
            
            if (fileInput.files.length > 0) {
                const originalFileName = fileInput.files[0].name;
                baseName = originalFileName.replace(/\.[^/.]+$/, ""); // 拡張子を削除
            }
            
            const date = new Date();
            const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
            
            return `${baseName}_${timestamp}.${extension}`;
        }
        
        // 画質スライダーの値更新
        function updateQualityValue() {
            const slider = document.getElementById('quality-slider');
            const valueDisplay = document.getElementById('quality-value');
            
            valueDisplay.textContent = `${slider.value}%`;
            outputQuality = parseInt(slider.value) / 100;
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateCustomSize();
            updateQualityValue();
        });
    </script>
</body>
</html>
